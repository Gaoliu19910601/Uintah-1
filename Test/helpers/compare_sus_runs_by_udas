#!/bin/sh

TEST=$1
TEST_UDADIR=$2
COMPARE_UDADIR=$3
SUS_DIR=$4
TMPDIR=$5

inputs_differ=0
echo
echo "Checking input files"
echo
diff -B $TEST_UDADIR/input.xml $COMPARE_UDADIR/input.xml
if [ $? != "0" ]; then
    echo
    echo "  Input files differ."
    inputs_differ=1
else
    echo "  Input files are the same."
fi

failed="0"
echo
echo "Comparing dat files"
echo "======================================"
echo

compare_dats $TEST $TEST_UDADIR $COMPARE_UDADIR $TMPDIR
compare_dats_retval=$?
if [ $compare_dats_retval = "1" ]; then
    echo 
    echo "*** dat comparison tests failed ***"
    failed="1"
elif [ $compare_dats_retval = "-1" ]; then
    failed="-1"
fi


echo
echo "Comparing udas"
echo "======================================"
echo
compare_udas $SUS_DIR $TEST $TEST_UDADIR $COMPARE_UDADIR $TMPDIR ""
uda_retval=$?
if [ $uda_retval != "0" ]; then
    echo 
    echo "*** uda comparison tests failed ***"
    failed="1"
fi

echo
echo "Comparing checkpoints"
echo "======================================"
echo
compare_udas $SUS_DIR $TEST $TEST_UDADIR/checkpoints $COMPARE_UDADIR/checkpoints $TMPDIR "-skip_unknown_types"
chp_retval=$?
if [ $chp_retval != "0" ]; then
    echo 
    echo "*** checkpoint comparison tests failed ***"
    failed="1"
fi

if [ $failed != "0" ]; then
    if [ $inputs_differ = "1" ]; then
        exit 5;
    fi
    exit $failed
fi

if [ $inputs_differ = "1" ]; then
    exit 10;
fi

exit 0

