# Makefile for field manipulation code that is compiled and loaded on the fly

# Default target
default: all

SCIRUN_SRCTOP = ../../../../

include $(SCIRUN_SRCTOP)configVars.mk

SRCTOP := $(SCIRUN_SRCTOP)$(SRCTOP)

INCLUDES = -I$(SRCTOP)/include -I$(SRCTOP)/include/compat -I$(SRCTOP) -I$(OBJTOP) -I@TCL_INCLUDE_DIR@ -I@TK_INCLUDE_DIR@ -I@ITCL_INCLUDE_DIR@ -I@BLT_INCLUDE_DIR@ @GLOBUS_INCLUDE@ $(XML_INCLUDE) -I@GL_INCLUDE_DIR@ $(PETSC_INCLUDES)

LIBDIR := -L../../../../lib/

include sub.mk

# The libraries are specified like Core/Thread but get
# name-mangled to Core_Thread
SRLIBS := $(subst /,_,$(SRLIBS))

MANIP_LIBS := $(patsubst %.cc,%.so, $(SRCS))

ifeq ($(NEED_SONAME),yes)
SONAMEFLAG = -Wl,-soname,$(notdir $@)
else
SONAMEFLAG = 
endif

#$(patsubst %,$(LIBDIR)lib%.so,$(SRLIBS)

.SUFFIXES: .cc .so

Makefile: Makefile.in ${SCIRUN_SRCTOP}/config.status
	@( Here="`pwd`" ; cd ${SCIRUN_SRCTOP} ; Top="`pwd`" ; CONFIG_FILES="`echo $${Here} | sed -e "s!^$${Top}/!!" -e "s!^$${Top}!.!"`/Makefile" CONFIG_HEADERS="" ./config.status ) 1>&2

.cc.so: $< Makefile sub.mk
	rm -f $@
	echo 'helo' $(patsubst %.cc,$(%LIBS),$<)
	$(CXX) $(CFLAGS) $($(patsubst %.cc,%INCLUDES,$<)) $(INCLUDES) $(CC_DEPEND_REGEN) $(SOFLAGS) $< -o $@ $(SONAMEFLAG) $($(patsubst %.cc,%LIBPATH,$<)) $(LIBDIR) $($(patsubst %.cc,%LIBS,$<))

all: $(MANIP_LIBS)
