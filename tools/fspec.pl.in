#!@PERL@

$g77=@G77@;

$source=shift;
$output=shift;
&usage() unless $source && $output;

open(FILE, "<$source") or die "cannot open $source for reading: $!";

open(OUT, ">$output");

while($line = <FILE>){
 # Scan for the return type.  Must be a simple type, or void
    chomp($line);
    while(!($line =~ /;/)){
	$line.=<FILE>;
	chomp($line);
    }
    ($ret, $fn, $arg) = ($line =~ /(\w*)\s+(\w*)\s*\((.*)\)\s*\;/);
    if($ret eq "" || $fn eq ""){
	print "line=$line";
	die "Cannot parse function and return type";
    }
    @args = split /,/,$arg;
    foreach $a (@args) {
	($type, $tmpltype, $name) = &parsearg($a);
	if(&simpletype($type)){
	} elsif(&knownvartype($type) && &simpletype($tmpltype)){
	} elsif(&knownarraytype($type) && &simpletype($tmpltype)){
	} elsif(&othertype($type)){
	} else {
	    die "Cannot understand type: $a";
	}
    }
    # Emit C++ code
    print OUT "\n#ifndef fspec_$fn\n";
    print OUT "#define fspec_$fn\n\n";
    print OUT "#ifdef __cplusplus\n\n";
    print OUT "extern \"C\" ";
    print OUT "$ret $fn\_(";
    $sep="";
    foreach $a (@args) {
	print OUT $sep;
	$sep=", ";
	($type, $tmpltype, $name) = &parsearg($a);
	if(&simpletype($type)){
	    print OUT "$type\* $name";
	} elsif(&knownvartype($type) && &simpletype($tmpltype)){
	    if($g77){
		foreach $v ("low_x", "low_y", "low_z", "high_x", "high_y", "high_z") {
		    print OUT "int* $name\_$v, ";
		}
	    } else {
		print OUT "int* $name\_low, ";
		print OUT "int* $name\_high, ";
	    }
	    print OUT "$tmpltype\* $name\_ptr";
	} elsif(&knownarraytype($type) && &simpletype($tmpltype)){
	    print OUT "int* $name\_size, ";
	    print OUT "$tmpltype\* $name\_ptr";
	} elsif(&othertype($type)){
	    if($type == "IntVector"){
		print OUT "int* $name";
	    }
	}
	
    }
    print OUT ");\n\n";
    print OUT "static $ret fort_$fn(";
    $sep="";
    foreach $a (@args){
	print OUT $sep;
	$sep=", ";
	($type, $tmpltype, $name) = &parsearg($a);
	if($tmpltype ne ""){
	    print OUT "$type<$tmpltype>& $name";
	} else {
	    print OUT "$type& $name";
	}
    }
    print OUT ")\n{\n";
    foreach $a (@args) {
	($type, $tmpltype, $name) = &parsearg($a);
	if(&knownvartype($type)){
	    print OUT "  IntVector $name\_low = $name.getFortLowIndex();\n";
	    print OUT "  IntVector $name\_high = $name.getFortHighIndex();\n";
	    if($g77){
		foreach $d ("x", "y", "z") {
		    print OUT "  int $name\_low_$d = $name\_low.$d();\n";
		    print OUT "  int $name\_high_$d = $name\_high.$d();\n";
		}
	    }
	} elsif(&knownarraytype($type)){
	    print OUT "  int $name\_size = $name.size();\n";
	}
    }
    print OUT "  ";
    if($ret != "void"){
	print OUT "return ";
    }
    print OUT "$fn\_(";
    $sep="";
    foreach $a (@args) {
	($type, $tmpltype, $name) = &parsearg($a);
	print OUT $sep;
	$sep=", ";
	if(&simpletype($type)){
	    print OUT "&$name";
	} elsif(&knownvartype($type)){
	    if($g77){
		foreach $v ("low_x", "low_y", "low_z", "high_x", "high_y", "high_z") {
		    print OUT "&$name\_$v, ";
		}
	    } else {
		print OUT "$name\_low.get_pointer(), ";
		print OUT "$name\_high.get_pointer(), ";
	    }
	    print OUT "$name.getPointer()";
	} elsif(&knownarraytype($type)){
	    print OUT "&$name\_size, ";
	    print OUT "$name\.get_objs()";
	} elsif(&othertype($type)){
	    print OUT "$name.get_pointer()";
	}
    }

    print OUT ");\n";
    print OUT "}\n\n";
    print OUT "#else /* !__cplusplus */\n";
    # Emit fortran code
    print OUT "C Assuming this is fortran code\n\n";

    $s="subroutine $fn(";
    $sep="";
    foreach $a (@args) {
	($type, $tmpltype, $name) = &parsearg($a);
	$s.=$sep;
	$sep=", ";
	if(&simpletype($type)){
	    $s.="$name";
	} elsif(&knownvartype($type) && &simpletype($tmpltype)){
	    if($g77){
		foreach $v ("low_x", "low_y", "low_z", "high_x", "high_y", "high_z") {
		    $s.="$name\_$v, ";
		}
	    } else {
		$s.="$name\_low, ";
		$s.="$name\_high, ";
	    }
	    $s.="$name";
	} elsif(&knownarraytype($type) && &simpletype($tmpltype)){
	    $s.="$name\_size, ";
	    $s.="$name";
	} elsif(&othertype($type)){
	    if($type == "IntVector"){
		$s.="$name";
	    }
	}
    }
    $s.=")";
    
    print OUT &formatf($s)."\n\n";
    print OUT "      implicit none\n";
    
    foreach $a (@args) {
	($type, $tmpltype, $name) = &parsearg($a);
	if(&simpletype($type)){
	    $ftype=&ftype($type);
	    print OUT "      $ftype $name\n";
	} elsif(&knownvartype($type) && &simpletype($tmpltype)){
	    $s="integer ";
	    $sep="";
	    if($g77){
		foreach $v ("low_x", "low_y", "low_z", "high_x", "high_y", "high_z") {
		    $s.=$sep;
		    $sep=", ";
		    $s.="$name\_$v";
		}
	    } else {
		$s.="$name\_low(3), ";
		$s.="$name\_high(3)";
	    }
	    print OUT &formatf($s)."\n";
	    $ftype=&ftype($tmpltype);
	    $s="$ftype $name(";
	    if($g77){
		$sep="";
		foreach $v ("x", "y", "z"){
		    $s.=$sep;
		    $sep=", ";
		    $s.="$name\_low_$v:$name\_high_$v";
		}
	    } else {
		$sep="";
		foreach $v ("1", "2", "3"){
		    $s.=$sep;
		    $sep=", ";
		    $s.="$name\_low($v):$name\_high($v)";
		}
	    }
	    $s.=")";
	    print OUT &formatf($s)."\n";
	} elsif(&knownarraytype($type) && &simpletype($tmpltype)){
	    print OUT "      integer $name\_size\n";
	    $ftype=&ftype($tmpltype);
	    print OUT "      $ftype $name($name\_size)\n";
	} elsif(&othertype($type)){
	    if($type == "IntVector"){
		print OUT "      integer $name(3)\n";
	    }
	}
    }
    print OUT "#endif /* __cplusplus */\n";
    print OUT "\n#endif /* fspec_$fn */\n\n";
}

close FILE;
close OUT;

sub usage {
    print<<EOM;
Usage:
    $0 <source> <output>
EOM
    exit(1);
}

sub parsearg {
    ($type, $tmpltype, $name) = ($_[0] =~ /\s*(\w+)\s*\<\s*(\w+)\s*>\s*(\w+)\s*/);
    if(!$type){
	($type, $name) = ($_[0] =~ /\s*(\w+)\s+(\w+)\s*/);
    }
    ($type, $tmpltype, $name);
}

sub simpletype {
    $type = $_[0];
    if($type eq "double" || $type eq "int"){
	1;
    } else {
	0;
    }
}

sub knownvartype {
    $type = $_[0];
    if($type eq "CCVariable" || $type eq "NCVariable" || $type eq "SFCXVariable" || $type eq "SFCYVariable" || $type eq "SFCZVariable") {
	1;
    } else {
	0;
    }
}

sub knownarraytype {
    $type = $_[0];
    if($type eq "Array1") {
	1;
    } else {
	0;
    }
}

sub othertype {
    $type = $_[0];
    if($type eq "IntVector") {
	1;
    } else {
	0;
    }
}

sub formatf {
    $f=$_[0];
    $s="";
    $cur="      ";
    while($f ne ""){
	($first, $rest) = ($f =~ /^([,\(\)\:]|\w+|\s+)(.*)/);
	if($first eq ""){
	    die "re broke\n";
	}
	if(length($cur.$first) >= 72){
	    $s.=$cur."\n";
	    $cur="     & ";
	    if(length($cur.$first) >= 72){
		die "token more than 66 chars, cannot format line!";
	    }
	}
	$cur.=$first;
	$f=$rest;
    }
    $s.$cur;
}

sub ftype {
    $type =$_[0];
    if($type eq "double") {
	"double precision";
    } elsif($type eq "int") {
	"integer";
    } else {
	"unknown ftype";
    }
}
